<link href="../libraries/polymer/polymer.html" rel="import">
<dom-module id="task-action">
	<template>
		<style>
			:host, div {
				position: absolute;
				right: 32px;
				bottom: 32px;
				width: 64px;
				height: 64px;
				border-radius: 32px;
				background-color: #ff5722;
				display: flex;
				justify-content: center;
				align-items: center;
				color: white;
				cursor: pointer;
			}

			:host.pressed, div.pressed {
				background-color: #f5f5f5;
				color: #9e9e9e;
			}

			div.save {
				right: 0;
				bottom: 192px;
				opacity: 1;
			}

			div.delete {
				right: 136px;
				bottom: 136px;
				opacity: 1;
			}

			div.create {
				right: 192px;
				bottom: 0;
				opacity: 1;
			}

			div[class~="save"].pressed {
				right: 0;
				bottom: 96px;
				opacity: 0;
			}

			div[class~="delete"].pressed {
				right: 68px;
				bottom: 68px;
				opacity: 0;
			}

			div[class~="create"].pressed {
				right: 96px;
				bottom: 0;
				opacity: 0;
			}
		</style>
		<i>view_list</i>

		<div class="save shadow-floating transition pressed">
			<i>save</i>
		</div>
		<div class="delete shadow-floating transition pressed">
			<i>delete</i>
		</div>
		<div class="create shadow-floating transition pressed">
			<i>create</i>
		</div>
	</template>
	<script>
		Polymer({
			is: 'task-action',
			properties: {
				tasks: {
					type: Array,
					value: [],
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				},
				selector: {
					type: Object,
					value: null,
					readOnly: false,
					notify: false,
					reflectToAttribute: false
				},
				settings: {
					type: Object,
					value: null,
					readOnly: false,
					notify: false,
					reflectToAttribute: false
				}
			},
			created: function () {
				this.classList.add('shadow-floating');
			},
			attached: function () {
				this.listen(this, tapEventName, 'toggle');
				var elements = this.getElementsByClassName('create');
				var length = elements.length;
				var i;
				for (i = 0; i < length; i++) this.listen(elements[i], tapEventName, 'create');
				elements = this.getElementsByClassName('delete');
				length = elements.length;
				for (i = 0; i < length; i++) this.listen(elements[i], tapEventName, 'delete');
				elements = this.getElementsByClassName('save');
				length = elements.length;
				for (i = 0; i < length; i++) this.listen(elements[i], tapEventName, 'save');
			},
			detached: function () {
				this.unlisten(this, tapEventName, 'toggle');
				var elements = this.getElementsByClassName('create');
				var length = elements.length;
				var i;
				for (i = 0; i < length; i++) this.unlisten(elements[i], tapEventName, 'create');
				elements = this.getElementsByClassName('delete');
				length = elements.length;
				for (i = 0; i < length; i++) this.unlisten(elements[i], tapEventName, 'delete');
				elements = this.getElementsByClassName('save');
				length = elements.length;
				for (i = 0; i < length; i++) this.unlisten(elements[i], tapEventName, 'save');
			},
			toggle: function (event) {
				if (event) event.stopPropagation();
				var classes = this.classList;
				var elements = this.getElementsByTagName('div');
				var length = elements.length;
				var i;
				if (classes.contains('pressed')) {
					for (i = 0; i < length; i++) elements[i].classList.add('pressed');
					classes.remove('pressed');
					setTimeout(function () {
						for (var i = 0; i < length; i++) elements[i].classList.add('hidden');
					}, 150);
				} else {
					for (i = 0; i < length; i++) elements[i].classList.remove('hidden');
					setTimeout(function () {
						classes.add('pressed');
						for (var i = 0; i < length; i++) elements[i].classList.remove('pressed');
					}, 0);
				}
			},
			create: function () {
				var date = (new Date()).toJSON();
				date = date.substring(0, date.indexOf('T'));
				var task = {
					category: '',
					deadline: date,
					description: '',
					priority: 3,
					selected: true,
					status: 'Open',
					title: '',
					user: ''
				};
				this.push('tasks', task);
				var selector = this.selector;
				if (selector) {
					var lastSelected = selector.lastSelected;
					if (lastSelected) {
						lastSelected.item.selected = false;
						this.fireTaskSelect(lastSelected.key, false);
					}
					selector.select(task);
					selector.lastSelected = {
						key: document.getElementById('list').__data__['items.splices'].keySplices[0].added[0],
						item: task
					};
				}
			},
			delete: function () {
				var selector = this.selector;
				if (selector && selector.selected) {
					selector.selected.deleted = true;
					var index = findIndex(this.tasks, function (item) {
						return item.deleted;
					});
					selector.deselect(this.tasks[index]);
					this.splice('tasks', index, 1);
				}
			},
			save: function () {
				var server;
				if (this.settings && (server = this.settings.server)) {
					var request = new XMLHttpRequest();
					request.onreadystatechange = function () {
						if (this.readyState === XMLHttpRequest.DONE) {
							if (this.status >= 200 && this.status < 300) {
								console.log("Response Body: %s", this.responseText);
							} else {
								console.log("Response Status: %d (%s)", this.status, this.statusText);
							}
						}
					};
					request.open('PUT', server.url, true, server.user, server.password);
					request.setRequestHeader('Content-Type', 'application/json');
					request.send(JSON.stringify(this.tasks));
				}
			},
			fireTaskSelect: function (key, value) {
				var detail = {
					path: 'tasks.' + key + '.selected',
					value: value
				};
				this.fire('tasks-changed', detail);
			}
		})
	</script>
</dom-module>
