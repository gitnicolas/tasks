<link href="../libraries/polymer/polymer.html" rel="import">
<dom-module id="task-action">
	<template>
		<style>
			:host, div {
				position: absolute;
				right: 32px;
				bottom: 32px;
				width: 64px;
				height: 64px;
				border-radius: 32px;
				background-color: #ff5722;
				display: flex;
				justify-content: center;
				align-items: center;
				color: white;
				cursor: pointer;
			}

			:host.pressed, div.pressed {
				background-color: #f5f5f5;
				color: #9e9e9e;
			}

			div.refresh {
				right: 0;
				bottom: 192px;
				opacity: 1;
			}

			div.delete {
				right: 136px;
				bottom: 136px;
				opacity: 1;
			}

			div.create {
				right: 192px;
				bottom: 0;
				opacity: 1;
			}

			div[class~="refresh"].pressed {
				right: 0;
				bottom: 96px;
				opacity: 0;
			}

			div[class~="delete"].pressed {
				right: 68px;
				bottom: 68px;
				opacity: 0;
			}

			div[class~="create"].pressed {
				right: 96px;
				bottom: 0;
				opacity: 0;
			}
		</style>
		<i>view_list</i>

		<div class="refresh shadow-floating transition pressed">
			<i>refresh</i>
		</div>
		<div class="delete shadow-floating transition pressed">
			<i>delete</i>
		</div>
		<div class="create shadow-floating transition pressed">
			<i>create</i>
		</div>
	</template>
	<script>
		Polymer({
			is: 'task-action',
			properties: {
				tasks: {
					type: Array,
					value: [],
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				},
				selected: {
					type: Object,
					value: null,
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				}
			},
			created: function () {
				this.classList.add('shadow-floating');
			},
			attached: function () {
				this.listen(this, tapEventName, 'toggle');
				var elements = this.getElementsByClassName('create');
				var length = elements.length;
				var i;
				for (i = 0; i < length; i++) this.listen(elements[i], tapEventName, 'create');
				elements = this.getElementsByClassName('delete');
				length = elements.length;
				for (i = 0; i < length; i++) this.listen(elements[i], tapEventName, 'delete');
			},
			detached: function () {
				this.unlisten(this, tapEventName, 'toggle');
				var elements = this.getElementsByClassName('create');
				var length = elements.length;
				var i;
				for (i = 0; i < length; i++) this.unlisten(elements[i], tapEventName, 'create');
				elements = this.getElementsByClassName('delete');
				length = elements.length;
				for (i = 0; i < length; i++) this.unlisten(elements[i], tapEventName, 'delete');
			},
			toggle: function (event) {
				if (event) event.stopPropagation();
				var classes = this.classList;
				var elements = this.getElementsByTagName('div');
				var length = elements.length;
				var i;
				if (classes.contains('pressed')) {
					for (i = 0; i < length; i++) elements[i].classList.add('pressed');
					classes.remove('pressed');
					setTimeout(function () {
						for (var i = 0; i < length; i++) elements[i].classList.add('hidden');
					}, 150);
				} else {
					for (i = 0; i < length; i++) elements[i].classList.remove('hidden');
					setTimeout(function () {
						classes.add('pressed');
						for (var i = 0; i < length; i++) elements[i].classList.remove('pressed');
					}, 0);
				}
			},
			create: function () {
				var date = (new Date()).toJSON();
				date = date.substring(0, date.indexOf('T'));
				var task = {
					"category": "",
					"deadline": date,
					"description": "",
					"priority": 3,
					"status": "Open",
					"title": "",
					"user": ""
				};
				this.push('tasks', task);
				var selector = document.getElementById('selector');
				if (selector) selector.select(task);
				else this.selected = task;
			},
			delete: function () {
				if (this.selected) {
					this.selected.deleted = true;
					var index = this.tasks.findIndex(function (item) {
						return item.deleted;
					});
					var selector = document.getElementById('selector');
					if (selector) selector.select(this.tasks[index]);
					else this.selected = null;
					this.splice('tasks', index, 1);
				}
			},
			save: function () {
				var request = new XMLHttpRequest();
				request.onreadystatechange = function () {
					if (this.readyState === XMLHttpRequest.DONE) {
						if (this.status >= 200 && this.status < 300) {
							console.log("Response Body: %s", this.responseText);
						} else {
							console.log("Response Status: %d (%s)", this.status, this.statusText);
						}
					}
				};
				request.open('GET', 'http://www.mozilla.org/', true);
				request.send(null);
			}
		})
	</script>
</dom-module>
