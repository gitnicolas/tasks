<link href="../libraries/polymer/polymer.html" rel="import">
<link href="task-card.html" rel="import">
<link href="task-detail.html" rel="import">
<dom-module id="task-list">
	<template>
		<style>
			:host {
				flex: 1 1;
				display: flex;
			}

			div.view {
				flex: 1 1 auto;
				overflow-y: auto;
			}

			div.view:nth-of-type(2) {
				min-width: 40%;
				background-color: white;
			}

			@media (max-width: 575px) {
				:host {
					flex-direction: column;
				}

				div.view:nth-of-type(2) {
					min-width: inherit;
					min-height: 276px;
				}
			}

			div.list-header {
				display: flex;
			}

			div.counter {
				margin: 20px 20px 20px 0;
				border-radius: 10px;
				padding: 0 6px;
				background-color: #607d8b;
				white-space: nowrap;
				color: white;
			}
		</style>
		<div class="view">
			<div class="list-header">
				<input type="search" name="filter" value="{{filterString::input}}" title="Filter" placeholder="Search: Category, Title, User">

				<div class="counter">[[displayed]] of [[tasks.length]]</div>
			</div>
			<template is="dom-repeat" id="list" items="[[tasks]]" as="task" filter="[[computeFilter(filterString)]]" sort="sortByEmergency" observe="deadline priority category title user status">
				<task-card task="[[task]]" on-click="select"></task-card>
			</template>
		</div>
		<array-selector id="selector" items="{{tasks}}" selected="{{task}}" toggle></array-selector>
		<template is="dom-if" if="[[task]]">
			<div class="view shadow-previous">
				<task-detail task="{{task}}"></task-detail>
			</div>
		</template>
	</template>
	<script>
		Polymer({
			is: 'task-list',
			properties: {
				displayed: {
					type: Number,
					value: 0,
					readOnly: false,
					notify: false,
					reflectToAttribute: false
				},
				isReady: {
					type: Boolean,
					value: false,
					readOnly: false,
					notify: false,
					reflectToAttribute: false
				},
				selector: {
					type: Object,
					value: null,
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				},
				tasks: {
					type: Array,
					value: [],
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				}
			},
			observers: [
				'persist(filterString)'
			],
			ready: function () {
				this.selector = this.$.selector;
				var filterString = localStorage.getItem('filter');
				if (filterString) this.filterString = filterString;
				this.isReady = true;
			},
			attached: function () {
				this.listen(this.$.list, 'rendered-item-count-changed', 'updateDisplayed');
			},
			detached: function () {
				this.unlisten(this.$.list, 'rendered-item-count-changed', 'updateDisplayed');
			},
			persist: function () {
				if (this.isReady) this.debounce('persist', function () {
					localStorage.setItem('filter', this.filterString);
				}, 500);
			},
			updateDisplayed: function () {
				this.displayed = this.$.list.renderedItemCount;
				this.fire('displayed-changed', {
					path: 'displayed',
					value: this.displayed
				});
			},
			computeFilter: function (filterString) {
				if (filterString && (filterString = filterString.trim())) {
					filterString = filterString.toUpperCase();
					return function (task) {
						var category = task.category.toUpperCase();
						var title = task.title.toUpperCase();
						var user = task.user.toUpperCase();
						return (category.indexOf(filterString) !== -1 || title.indexOf(filterString) !== -1 || user.indexOf(filterString) !== -1);
					};
				}
				return null;
			},
			sortByEmergency: function (a, b) {
				if (a.status !== finalTaskStatus && b.status === finalTaskStatus) return -1;
				if (a.status === finalTaskStatus && b.status !== finalTaskStatus) return 1;
				if (a.deadline < b.deadline) return -1;
				if (a.deadline > b.deadline) return 1;
				if (a.priority < b.priority) return 1;
				if (a.priority > b.priority) return -1;
				return 0;
			},
			sortByTitle: function (a, b) {
				var titleA = a.title.toUpperCase();
				var titleB = b.title.toUpperCase();
				if (titleA < titleB) return -1;
				if (titleA > titleB) return 1;
				return 0;
			},
			select: function (event) {
				var selector = this.selector;
				var model = this.$.list.modelForElement(event.target);
				var item = model.task;
				if (selector.isSelected(item)) {
					item.selected = false;
					selector.deselect(item);
					selector.lastSelected = null;
				} else {
					var lastSelected = selector.lastSelected;
					if (lastSelected) {
						lastSelected.item.selected = false;
						this.fireTaskSelect(lastSelected.key, false);
					}
					item.selected = true;
					selector.select(item);
					selector.lastSelected = {
						key: model.__key__,
						item: model.task
					};
				}
				this.fireTaskSelect(model.__key__, item.selected);
			},
			fireTaskSelect: function (key, value) {
				this.fire('tasks-changed', {
					path: 'tasks.' + key + '.selected',
					value: value
				});
			}
		})
	</script>
</dom-module>
