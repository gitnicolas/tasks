<link href="../libraries/polymer/polymer.html" rel="import">
<link href="task-card.html" rel="import">
<link href="task-detail.html" rel="import">
<dom-module id="task-list">
	<template>
		<style>
			:host {
				flex: 1 1 0;
				display: flex;
			}

			div.view {
				flex: 1 1 auto;
				overflow-y: auto;
			}

			div.view:nth-of-type(2) {
				border-left: 1px solid #eeeeee;
			}

			@media (max-width: 575px) {
				:host {
					flex-direction: column;
				}

				div.view:nth-of-type(2) {
					min-height: 276px;
					border-left: inherit;
					border-top: 1px solid #eeeeee;
				}
			}
		</style>
		<div class="view">
			<input type="search" name="filter" value="{{filterString::input}}" title="Filter" placeholder="Search: Category, Title, User">
			<template is="dom-repeat" id="list" items="[[tasks]]" as="task" filter="[[computeFilter(filterString)]]" sort="sortByEmergency" observe="deadline priority category title user">
				<task-card task="[[task]]" on-click="select"></task-card>
			</template>
		</div>
		<array-selector id="selector" items="{{tasks}}" selected="{{task}}" toggle></array-selector>
		<template is="dom-if" if="[[task]]">
			<div class="view">
				<task-detail task="{{task}}"></task-detail>
			</div>
		</template>
	</template>
	<script>
		Polymer({
			is: 'task-list',
			properties: {
				tasks: {
					type: Array,
					value: [],
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				},
				selector: {
					type: Object,
					value: null,
					readOnly: false,
					notify: true,
					reflectToAttribute: false
				}
			},
			ready: function () {
				this.selector = this.$.selector;
			},
			computeFilter: function (filterString) {
				if (filterString) {
					filterString = filterString.trim();
					if (filterString) {
						filterString = filterString.toUpperCase();
						return function (task) {
							var category = task.category.toUpperCase();
							var title = task.title.toUpperCase();
							var user = task.user.toUpperCase();
							return (category.indexOf(filterString) != -1 || title.indexOf(filterString) != -1 || user.indexOf(filterString) != -1);
						};
					}
				}
				return null;
			},
			sortByEmergency: function (a, b) {
				if (a.deadline < b.deadline) return -1;
				if (a.deadline > b.deadline) return 1;
				if (a.priority < b.priority) return 1;
				if (a.priority > b.priority) return -1;
				return 0;
			},
			sortByTitle: function (a, b) {
				var titleA = a.title.toUpperCase();
				var titleB = b.title.toUpperCase();
				if (titleA < titleB) return -1;
				if (titleA > titleB) return 1;
				return 0;
			},
			select: function (event) {
				var target = 'TASK-CARD';
				var style = 'selected';
				var element = event.target;
				while (element.tagName.toUpperCase() !== target) element = element.parentElement;
				var classes = element.classList;
				if (classes.contains(style)) classes.remove(style);
				else classes.add(style);
				this.selector.select(this.$.list.itemForElement(element));
			}
		})
	</script>
</dom-module>
